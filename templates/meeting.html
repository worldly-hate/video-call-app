{% extends "base.html" %}

{% block full_content %}
<div class="container">
    <h1>Video Meeting Room</h1>
    <div id="video-container"></div>
    <canvas id="drawing-canvas"></canvas>
    
    <div class="controls">
        <button onclick="startCall()">Start Call</button>
        <button onclick="toggleMic()">Toggle Mic</button>
        <button onclick="toggleCamera()">Toggle Camera</button>
        <button onclick="toggleDrawing()">Toggle Drawing</button>
        <button onclick="leaveCall()">Leave Call</button>
    </div>

    <div class="drawing-controls" id="drawing-controls">
        <button onclick="clearCanvas()">Clear</button>
        <button class="color-btn" onclick="setColor('#0000FF')" style="background: blue;"></button>
        <button class="color-btn" onclick="setColor('#00FF00')" style="background: green;"></button>
        <button class="color-btn" onclick="setColor('#FF0000')" style="background: red;"></button>
        <button class="color-btn" onclick="setColor('#FFFF00')" style="background: yellow;"></button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
<script src="https://web.sdk.qcloud.com/im/im-sdk-v2/im.js"></script>
<script src="https://web.sdk.qcloud.com/zego/zegocloud/zegocloud.js"></script>
<script src="{{ url_for('static', filename='js/hand_gesture.js') }}"></script>
<script>
async function initializeZegoCloud() {
    try {
        // Request permissions first
        await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        
        function getUrlParams(url) {
            let urlStr = url.split('?')[1];
            const urlSearchParams = new URLSearchParams(urlStr);
            const result = Object.fromEntries(urlSearchParams.entries());
            return result;
        }

        const roomID = getUrlParams(window.location.href)['roomID'] || (Math.floor(Math.random() * 10000) + "");
        const userID = Math.floor(Math.random() * 10000) + "";
        const userName = "{{username}}";
        const appID = 819347417;
        const serverSecret = "ba06e342c41afb5e02221e369d22de62";
        const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(appID, serverSecret, roomID, userID, userName);

        const zp = ZegoUIKitPrebuilt.create(kitToken);
        zp.joinRoom({
            container: document.querySelector("#video-container"),
            sharedLinks: [{
                name: 'Personal link',
                url: window.location.protocol + '//' + window.location.host + window.location.pathname + '?roomID=' + roomID,
            }],
            scenario: {
                mode: ZegoUIKitPrebuilt.VideoConference,
            },
            turnOnMicrophoneWhenJoining: true,
            turnOnCameraWhenJoining: true,
            showMyCameraToggleButton: true,
            showMyMicrophoneToggleButton: true,
            showAudioVideoSettingsButton: true,
            showScreenSharingButton: true,
            showTextChat: true,
            showUserList: true,
            maxUsers: 2,
            layout: "Auto",
            showLayoutButton: false,
        });
    } catch (error) {
        console.error("Error accessing media devices:", error);
        alert("Please allow camera and microphone access to use this application. If you denied permission, please reset permissions in your browser settings and refresh the page.");
    }
}

window.onload = initializeZegoCloud;

const localVideo = document.getElementById('local-player');
let stream;
let micEnabled = true;
let cameraEnabled = true;

async function startCall() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = stream;
        await localVideo.play();
    } catch (error) {
        console.error('Error accessing media devices:', error);
    }
}

function toggleMic() {
    if (stream) {
        stream.getAudioTracks().forEach(track => {
            track.enabled = !micEnabled;
        });
        micEnabled = !micEnabled;
    }
}

function toggleCamera() {
    if (stream) {
        stream.getVideoTracks().forEach(track => {
            track.enabled = !cameraEnabled;
        });
        cameraEnabled = !cameraEnabled;
    }
}

function leaveCall() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    window.location.href = "{{ url_for('dashboard') }}";
}

function toggleDrawing() {
    const drawingControls = document.getElementById('drawing-controls');
    const canvas = document.getElementById('drawing-canvas');
    if (drawingControls.style.display === 'none' || !drawingControls.style.display) {
        drawingControls.style.display = 'block';
        canvas.style.pointerEvents = 'auto';
    } else {
        drawingControls.style.display = 'none';
        canvas.style.pointerEvents = 'none';
    }
}

function clearCanvas() {
    const canvas = document.getElementById('drawing-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function setColor(color) {
    const canvas = document.getElementById('drawing-canvas');
    const ctx = canvas.getContext('2d');
    ctx.strokeStyle = color;
}

// Get the username from Flask
const username = "{{ username }}";
// Get room ID from URL parameters
const urlParams = new URLSearchParams(window.location.search);
const roomID = urlParams.get('roomID');
</script>
{% endblock %}